/*FINAL PROJECT - ELECTRIC VEHICLES */
/* BY DERRIK LOCASCIO, JESSE RENTERIA III, & TAMAS ZADOR */

%web_drop_table(WORK.IMPORT);

FILENAME REFFILE '/home/u56184515/sasuser.v94/Electric_Vehicle_Title_and_Registration_Activity2.csv';

PROC IMPORT DATAFILE=REFFILE
	DBMS=CSV
	OUT=WORK.IMPORT;
	GETNAMES=YES; RUN;

PROC CONTENTS DATA=WORK.IMPORT; RUN;

%web_open_table(WORK.IMPORT);

DATA ELECTRIC1 ; SET WORK.IMPORT ; RUN ;

PROC CONTENTS DATA=ELECTRIC1 ; RUN ; 

/* REMOVING DATA THAT IS NOT NEEDED */

DATA ELECTRIC2 ; SET ELECTRIC1 ; 
	IF BASE_MSRP > 800000 THEN DELETE ; 
	IF NEW_OR_USED = "Used" THEN DELETE ; 
	IF TRANSACTION_YEAR < 2015 THEN DELETE ;
	IF SALE_PRICE < 15000 THEN DELETE ; 
	IF MAKE = "TESLA" THEN TESLA=1 ; ELSE TESLA=0 ; 
	GAP = BASE_MSRP-SALE_PRICE ; RUN ;

/* CREATING THE DAY MONTH YEAR VARIABLES 
data ELECTRIC2  ; set ELECTRIC2 ; 
   date = datepart(Transaction_Date) ;
   yearmm = year(date)*100+month(date) ;
   month = month(date) ;
   quarter = qtr(date) ; 
   l_date = '31DEC2011'D ;
   format date l_date mmddyy10.     ;
 run ; */

/* DESCRIPTIVE ANALYTICS - ALL MODELS */

/* SUMMARY FOR TESLA VS NON-TESLA */
PROC SORT DATA=ELECTRIC2 ; BY TESLA ; RUN ;

PROC SUMMARY PRINT N MEAN MEDIAN STDDEV MIN MAX SKEWNESS DATA=ELECTRIC2; 
	VAR Sale_Price Electric_Range Base_MSRP GAP ; 
	BY TESLA ; RUN ; 
	
/* TESLA ONLY DATA */
DATA ELECTRIC_TESLA ; SET ELECTRIC2 ;
	IF MAKE ^= "TESLA" THEN DELETE ; RUN ;

PROC SUMMARY PRINT N MEAN MEDIAN STDDEV MIN MAX SKEWNESS DATA=ELECTRIC_TESLA; 
	VAR Sale_Price Electric_Range Base_MSRP GAP ; 
	CLASS MODEL ; RUN ; 

PROC SUMMARY PRINT N MEAN MEDIAN STDDEV MIN MAX SKEWNESS DATA=ELECTRIC_TESLA; 
	VAR Sale_Price Electric_Range Base_MSRP GAP ; 
	CLASS COUNTY ; RUN ; 

PROC UNIVARIATE DATA=ELECTRIC_TESLA ; 
	VAR Sale_Price Electric_Range ; RUN ; 

/* MERGING FOR CLUSTER - COUNTY */

PROC SUMMARY PRINT N MEAN  DATA=ELECTRIC2; 
	VAR ELECTRIC_RANGE ; 
	CLASS COUNTY ; 
	OUTPUT OUT=ELEC_COUNTY MEAN=MEAN_ELEC; RUN ;

PROC SUMMARY PRINT N MEAN  DATA=ELECTRIC2; 
	VAR SALE_PRICE; 
	CLASS COUNTY ; 
	OUTPUT OUT=SALE_COUNTY MEAN=MEAN_SALE ; RUN ; 

PROC SORT DATA=SALE_COUNTY ; BY DESCENDING MEAN_SALE ; RUN ;
PROC PRINT DATA=SALE_COUNTY(OBS=10); RUN ;

PROC SORT DATA=ELEC_COUNTY ; BY COUNTY ; RUN ; 
PROC SORT DATA=SALE_COUNTY ; BY COUNTY ; RUN ;

DATA ELECTRIC_CL ; MERGE ELEC_COUNTY SALE_COUNTY ; BY COUNTY ; RUN ;

DATA ELECTRIC_CL ; SET ELECTRIC_CL ; 
	IF COUNTY = " " THEN DELETE ; RUN ; 

PROC SORT DATA=ELECTRIC_CL ; BY DESCENDING MEAN_ELEC ; RUN ;
PROC PRINT DATA=ELECTRIC_CL(OBS=10); RUN ;

TITLE "ELECTRIC VEHICLE BY COUNTY" ;
PROC SGPLOT DATA=ELECTRIC_CL;
	SCATTER X=MEAN_ELEC Y=MEAN_SALE / DATALABEL=COUNTY; 
	REG X=MEAN_ELEC Y=MEAN_SALE ; RUN ; 

PROC CLUSTER DATA=ELECTRIC_CL OUT=CLS_ELECTRIC METHOD=WARD CCC PSEUDO PRINT=7 ;
	VAR MEAN_ELEC MEAN_SALE ; copy COUNTY ; RUN ; 
PROC PRINT DATA=CLS_ELECTRIC ; RUN ;

PROC TREE DATA=CLS_ELECTRIC OUT=TREE_ELECTRIC NCL=3;
	COPY MEAN_ELEC MEAN_SALE COUNTY ; RUN ;
PROC PRINT DATA=TREE_ELECTRIC ; RUN ;

PROC SGPLOT DATA=TREE_ELECTRIC ; 
	SCATTER X=MEAN_ELEC Y=MEAN_SALE / GROUP=CLUSTER DATALABEL=COUNTY ;  
	REG X=MEAN_ELEC Y=MEAN_SALE / GROUP=CLUSTER ; RUN ;

PROC FASTCLUS DATA=ELECTRIC_CL MAXCLUSTERS=3 OUT=KMEAN_ELECTRIC ; 
	VAR MEAN_ELEC MEAN_SALE ; RUN ;

PROC SGPLOT DATA=KMEAN_ELECTRIC ; 
	SCATTER X=MEAN_ELEC Y=MEAN_SALE / GROUP=CLUSTER DATALABEL=COUNTY ;  
	REG X=MEAN_ELEC Y=MEAN_SALE / GROUP=CLUSTER ; RUN ;


/* MERGING FOR CLUSTER - MAKE */

PROC SUMMARY PRINT N MEAN  DATA=ELECTRIC2; 
	VAR ELECTRIC_RANGE ; 
	CLASS MAKE ; 
	OUTPUT OUT=ELEC_MAKE MEAN=MEAN_ELEC; RUN ;

PROC SUMMARY PRINT N MEAN  DATA=ELECTRIC2; 
	VAR SALE_PRICE; 
	CLASS MAKE ; 
	OUTPUT OUT=SALE_MAKE MEAN=MEAN_SALE ; RUN ; 

PROC SORT DATA=SALE_MAKE ; BY DESCENDING MEAN_SALE ; RUN ;
PROC PRINT DATA=SALE_MAKE(OBS=10); RUN ;

PROC SORT DATA=ELEC_MAKE ; BY MAKE ; RUN ; 
PROC SORT DATA=SALE_MAKE ; BY MAKE ; RUN ;

DATA ELECTRIC_CL2 ; MERGE ELEC_MAKE SALE_MAKE ; BY MAKE ; RUN ;

DATA ELECTRIC_CL2 ; SET ELECTRIC_CL2 ; 
	IF MAKE = " " THEN DELETE ; RUN ; 

PROC SORT DATA=ELECTRIC_CL2 ; BY DESCENDING MEAN_ELEC ; RUN ;
PROC PRINT DATA=ELECTRIC_CL2(OBS=10); RUN ;

TITLE "ELECTRIC VEHICLE BY MAKE" ;
PROC SGPLOT DATA=ELECTRIC_CL2;
	SCATTER X=MEAN_ELEC Y=MEAN_SALE / DATALABEL=MAKE; 
	REG X=MEAN_ELEC Y=MEAN_SALE ; RUN ; 

PROC CLUSTER DATA=ELECTRIC_CL2 OUT=CLS_ELECTRIC2 METHOD=WARD CCC PSEUDO PRINT=7 ;
	VAR MEAN_ELEC MEAN_SALE ; copy MAKE ; RUN ; 
PROC PRINT DATA=CLS_ELECTRIC2 ; RUN ;

PROC TREE DATA=CLS_ELECTRIC2 OUT=TREE_ELECTRIC2 NCL=3;
	COPY MEAN_ELEC MEAN_SALE MAKE ; RUN ;
PROC PRINT DATA=TREE_ELECTRIC2 ; RUN ;

PROC SGPLOT DATA=TREE_ELECTRIC2 ; 
	SCATTER X=MEAN_ELEC Y=MEAN_SALE / GROUP=CLUSTER DATALABEL=MAKE ;  
	REG X=MEAN_ELEC Y=MEAN_SALE / GROUP=CLUSTER ; RUN ;

PROC FASTCLUS DATA=ELECTRIC_CL2 MAXCLUSTERS=3 OUT=KMEAN_ELECTRIC2 ; 
	VAR MEAN_ELEC MEAN_SALE ; RUN ;

PROC SGPLOT DATA=KMEAN_ELECTRIC2 ; 
	SCATTER X=MEAN_ELEC Y=MEAN_SALE / GROUP=CLUSTER DATALABEL=MAKE ;  
	REG X=MEAN_ELEC Y=MEAN_SALE / GROUP=CLUSTER ; RUN ;

/* SUMMARY OF ALL THE DATA */
PROC SUMMARY PRINT N MEAN MEDIAN STDDEV MIN MAX SKEWNESS DATA=ELECTRIC2; 
	VAR Sale_Price Electric_Range Base_MSRP GAP ; RUN ; 

PROC UNIVARIATE DATA=ELECTRIC2 ; 
	VAR Sale_Price Electric_Range ; RUN ;

PROC CORR DATA=ELECTRIC2 COV ; 
	VAR Sale_Price Electric_Range ; RUN ; 

PROC ANOVA DATA=ELECTRIC2 ; 
	CLASS ELECTRIC_RANGE ;
	MODEL SALE_PRICE = ELECTRIC_RANGE ; RUN ; 

PROC SGPLOT DATA=electric2 ; 
	SCATTER Y=SALE_PRICE X=ELECTRIC_RANGE ; RUN ;

/* REGRESSION MODEL */

PROC REG DATA=ELECTRIC2 ; 
	MODEL SALE_PRICE = ELECTRIC_RANGE ; 
	OUTPUT OUT=REGOUT PREDICTED=YHAT RESIDUAL=RES1 ;
	RUN ;

PROC REG DATA=ELECTRIC2 ; 
	MODEL SALE_PRICE = ELECTRIC_RANGE GAP TRANSACTION_YEAR ;
	OUTPUT OUT=REGOUT PREDICTED=YHAT RESIDUAL=RES1 ;
	RUN ;

